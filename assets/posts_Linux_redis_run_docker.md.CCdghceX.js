import{_ as a,c as e,a2 as n,o as t}from"./chunks/framework.D_NaTb9t.js";const u=JSON.parse('{"title":"redis 在docker中慢的原因分析","description":"","frontmatter":{"title":"redis 在docker中慢的原因分析","hidemeta":true},"headers":[],"relativePath":"posts/Linux/redis_run_docker.md","filePath":"posts/Linux/redis_run_docker.md"}'),i={name:"posts/Linux/redis_run_docker.md"};function p(o,s,c,r,l,d){return t(),e("div",null,s[0]||(s[0]=[n(`<p>redis 在docker中慢的原因分析</p><h1 id="起因" tabindex="-1">起因 <a class="header-anchor" href="#起因" aria-label="Permalink to &quot;起因&quot;">​</a></h1><p>本来想实际测试一下mysql和redis到底差了多少, 按10w次, 发现mysql 用了18s, redis 用了15s,这不合理啊, 分析下原因, 确定是docker下跑redis的原因</p><p><a href="https://stackoverflow.com/questions/21691540/how-to-optimize-performance-for-a-docker-container" target="_blank" rel="noreferrer">和这个问题是一样的</a></p><h1 id="现象-redis-版本6-2-6" tabindex="-1">现象(redis 版本6.2.6) <a class="header-anchor" href="#现象-redis-版本6-2-6" aria-label="Permalink to &quot;现象(redis 版本6.2.6)&quot;">​</a></h1><h2 id="直接在系统内跑redis" tabindex="-1">直接在系统内跑redis <a class="header-anchor" href="#直接在系统内跑redis" aria-label="Permalink to &quot;直接在系统内跑redis&quot;">​</a></h2><h4 id="windows-5w" tabindex="-1">windows -&gt; 5w <a class="header-anchor" href="#windows-5w" aria-label="Permalink to &quot;windows -&gt; 5w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>C:\\redis&gt;redis-benchmark -t get -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 49925.11 requests per second</span></span></code></pre></div><h4 id="centos-virtualbox-10w" tabindex="-1">centos(virtualbox) -&gt; 10w <a class="header-anchor" href="#centos-virtualbox-10w" aria-label="Permalink to &quot;centos(virtualbox) -&gt; 10w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@localhost ~]# redis-benchmark -t get -h 192.168.56.101 -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 104712.05 requests per second</span></span></code></pre></div><h4 id="centos2-10w" tabindex="-1">centos2 -&gt; 10w <a class="header-anchor" href="#centos2-10w" aria-label="Permalink to &quot;centos2 -&gt; 10w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 109769.48 requests per second</span></span></code></pre></div><h4 id="macos-10w" tabindex="-1">macos -&gt;10w <a class="header-anchor" href="#macos-10w" aria-label="Permalink to &quot;macos -&gt;10w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>parapeng@localhost Homebrew % redis-benchmark -n 100000  -q -t set</span></span>
<span class="line"><span>SET: 101832.99 requests per second, p50=0.119 msec</span></span></code></pre></div><p>注意不能使用redis不能使用 127.0.0.1 要使用0.0.0.0, 否则会导致外网不能连接redis</p><h2 id="在docker中运行redis" tabindex="-1">在docker中运行redis <a class="header-anchor" href="#在docker中运行redis" aria-label="Permalink to &quot;在docker中运行redis&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker run -d --name redis-host  --net=host -p 6380:6380 redis</span></span></code></pre></div><h3 id="在容器内跑" tabindex="-1">在容器内跑: <a class="header-anchor" href="#在容器内跑" aria-label="Permalink to &quot;在容器内跑:&quot;">​</a></h3><h4 id="centos-virtualbox-3-3w" tabindex="-1">centos(virtualbox) -&gt;3.3w <a class="header-anchor" href="#centos-virtualbox-3-3w" aria-label="Permalink to &quot;centos(virtualbox) -&gt;3.3w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@localhost ~]#  docker exec -it 8c bash</span></span>
<span class="line"><span>root@8ca803e40423:/data# redis-benchmark -t get -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 33863.87 requests per second, p50=0.703 msec</span></span></code></pre></div><h4 id="centos2-3-3w" tabindex="-1">centos2-&gt;3.3w <a class="header-anchor" href="#centos2-3-3w" aria-label="Permalink to &quot;centos2-&gt;3.3w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# docker exec -it 10 bash</span></span>
<span class="line"><span>root@10357b39a9a9:/data# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 36982.25 requests per second, p50=0.671 msec</span></span></code></pre></div><h4 id="macos-8w" tabindex="-1">macos-&gt;8w <a class="header-anchor" href="#macos-8w" aria-label="Permalink to &quot;macos-&gt;8w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker exec -it fd /bin/sh</span></span>
<span class="line"><span># redis-benchmark -t get -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 80128.20 requests per second, p50=0.311 msec</span></span></code></pre></div><h3 id="在容器外跑" tabindex="-1">在容器外跑: <a class="header-anchor" href="#在容器外跑" aria-label="Permalink to &quot;在容器外跑:&quot;">​</a></h3><h4 id="macos-1w" tabindex="-1">macos-&gt;1w <a class="header-anchor" href="#macos-1w" aria-label="Permalink to &quot;macos-&gt;1w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>parapeng@localhost ~ % redis-benchmark -n 100000 -q -t set </span></span>
<span class="line"><span>SET: 11164.45 requests per second, p50=3.439 msec</span></span></code></pre></div><h4 id="centos1-9-8w" tabindex="-1">centos1-&gt;9.8w <a class="header-anchor" href="#centos1-9-8w" aria-label="Permalink to &quot;centos1-&gt;9.8w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@localhost ~]# redis-benchmark -t get  -n 100000  -q</span></span>
<span class="line"><span>GET: 98911.96 requests per second</span></span></code></pre></div><h4 id="centos2-10w-1" tabindex="-1">centos2-&gt;10w <a class="header-anchor" href="#centos2-10w-1" aria-label="Permalink to &quot;centos2-&gt;10w&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 104493.20 requests per second</span></span></code></pre></div><h3 id="在虚拟机外跑" tabindex="-1">在虚拟机外跑 <a class="header-anchor" href="#在虚拟机外跑" aria-label="Permalink to &quot;在虚拟机外跑&quot;">​</a></h3><h3 id="centos-2w" tabindex="-1">centos -&gt; 2w <a class="header-anchor" href="#centos-2w" aria-label="Permalink to &quot;centos  -&gt; 2w&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>C:\\redis&gt;redis-benchmark -t get -h 192.168.56.101 -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 22471.91 requests per second</span></span></code></pre></div><h2 id="为什么在docker-contianer内测会和直接在系统下测会有差别" tabindex="-1">为什么在docker-contianer内测会和直接在系统下测会有差别? <a class="header-anchor" href="#为什么在docker-contianer内测会和直接在系统下测会有差别" aria-label="Permalink to &quot;为什么在docker-contianer内测会和直接在系统下测会有差别?&quot;">​</a></h2><p>macos 下原本的10w在docker内只剩8w</p><p>centos 下更是从10w剩了3w</p><h2 id="为什么docker-container内外测会有差别" tabindex="-1">为什么docker-container内外测会有差别? <a class="header-anchor" href="#为什么docker-container内外测会有差别" aria-label="Permalink to &quot;为什么docker-container内外测会有差别?&quot;">​</a></h2><p>macos 从8w-&gt;2w</p><p>centos 从3w反而升到了8w</p><h2 id="为什么虚拟机内差这么多" tabindex="-1">为什么虚拟机内差这么多? <a class="header-anchor" href="#为什么虚拟机内差这么多" aria-label="Permalink to &quot;为什么虚拟机内差这么多?&quot;">​</a></h2><p>和<a href="https://stackoverflow.com/questions/21691540/how-to-optimize-performance-for-a-docker-container" target="_blank" rel="noreferrer">这里</a>说的一样是网络问题</p><h4 id="虚拟机使用桥接模式-3w" tabindex="-1">虚拟机使用桥接模式 -&gt;3W <a class="header-anchor" href="#虚拟机使用桥接模式-3w" aria-label="Permalink to &quot;虚拟机使用桥接模式 -&gt;3W&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>C:\\redis&gt;redis-benchmark -t get -h 172.16.0.181 -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 31715.82 requests per second</span></span></code></pre></div><h4 id="虚拟机使用host-only-2w" tabindex="-1">虚拟机使用host-only -&gt;2W <a class="header-anchor" href="#虚拟机使用host-only-2w" aria-label="Permalink to &quot;虚拟机使用host-only -&gt;2W&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>C:\\redis&gt;redis-benchmark -t get -h 192.168.56.101 -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 23679.85 requests per second</span></span></code></pre></div><h4 id="虚拟机使用网络地址转换-net-1w" tabindex="-1">虚拟机使用网络地址转换(Net) -&gt;1W <a class="header-anchor" href="#虚拟机使用网络地址转换-net-1w" aria-label="Permalink to &quot;虚拟机使用网络地址转换(Net) -&gt;1W&quot;">​</a></h4><p>此时添加端口转发 6379:6379</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>C:\\redis&gt;redis-benchmark -t get -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 13232.76 requests per second</span></span></code></pre></div><p>stackoverflow</p><h1 id="why-redis-benchmark-running-inside-a-docker-container-is-slower-than-running-outside-a-container" tabindex="-1">Why redis-benchmark running inside a docker-container is slower than running outside a container <a class="header-anchor" href="#why-redis-benchmark-running-inside-a-docker-container-is-slower-than-running-outside-a-container" aria-label="Permalink to &quot;Why redis-benchmark running inside a docker-container is slower than running outside a container&quot;">​</a></h1><p>i read <a href="https://stackoverflow.com/questions/21691540/how-to-optimize-performance-for-a-docker-container" target="_blank" rel="noreferrer">it</a>, which say &quot;With same redis-benchmark, redis-server runs inside a container much slower, than run on hosted OS&quot;, it like:</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph CentOS-case1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A(redis-benchmark)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph docker-container</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B(redis)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph CentOS-case2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A1(redis-benchmark) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B1(redis)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre></div><p>Case 1 is slower than case 2, but not by much:</p><p>case1-&gt;10.9w:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 109769.48 requests per second</span></span></code></pre></div><p>case2-&gt;10.4w:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 104493.20 requests per second</span></span></code></pre></div><p>But in this case:</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TB;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph CentOS-case3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgraph docker-container</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">A(redis-benchmark)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">B(redis)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end</span></span></code></pre></div><p>case3:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# docker exec -it 10 bash</span></span>
<span class="line"><span>root@10357b39a9a9:/data# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 36982.25 requests per second, p50=0.671 msec</span></span></code></pre></div><p>it drop rapidly to 3.6w, I&#39;m so confused, if i run redis in docker, why redis-benchmark runing in docker-container(case3) is slower than redis-benchmark runing in centos(case1)</p><p>I&#39;m afraid it&#39;s a computer problem, I did above cases again on the cloud server,it&#39;s same result :</p><p>case2 (centos cloud server) -&gt; 10w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 109769.48 requests per second</span></span></code></pre></div><p>case 1(centos cloud server) -&gt;9.8w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@localhost ~]# redis-benchmark -t get  -n 100000  -q</span></span>
<span class="line"><span>GET: 98911.96 requests per second</span></span></code></pre></div><p>case3(centos cloud server) -&gt;3.6 w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[root@pm-hw-hy ~]# docker exec -it 10 bash</span></span>
<span class="line"><span>root@10357b39a9a9:/data# redis-benchmark -t get -n 100000 -q</span></span>
<span class="line"><span>GET: 36982.25 requests per second, p50=0.671 msec</span></span></code></pre></div><p>I still don&#39;t believe this result, i run it in macos</p><p>case2 (macos) -&gt; 10w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>parapeng@localhost Homebrew % redis-benchmark -n 100000  -q -t set</span></span>
<span class="line"><span>SET: 101832.99 requests per second, p50=0.119 msec</span></span></code></pre></div><p>case 1(macos) -&gt;1w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>parapeng@localhost ~ % redis-benchmark -n 100000 -q -t set </span></span>
<span class="line"><span>SET: 11164.45 requests per second, p50=3.439 msec</span></span></code></pre></div><p>case3(macos) -&gt;8w</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker exec -it fd /bin/sh</span></span>
<span class="line"><span># redis-benchmark -t get -p 6379 -n 100000 -q</span></span>
<span class="line"><span>GET: 80128.20 requests per second, p50=0.311 msec</span></span></code></pre></div><p>This is my expected result:</p><p>case2 is slower than case3 because docker-network</p><p>case3 is slower than case2 because docker-contianer</p><p>who can help me answer, tks:</p><ol><li><p>case3 has less network than case2, why centos case3(3.6w) is slower than case2(10w)?</p></li><li><p>why centos and macos results are different</p></li></ol>`,82)]))}const g=a(i,[["render",p]]);export{u as __pageData,g as default};
